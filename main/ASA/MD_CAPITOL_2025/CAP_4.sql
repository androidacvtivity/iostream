-- 1127 query with rows 400, 410, 411, 412 added in the same pattern and numeric outputs rounded to 2 decimals
SELECT 
    ROUND(D.ANUL, 2) AS ANUL,
    ROUND(D.CUIIO, 2) AS CUIIO,
    R.IDNO,
    R.DENUMIRE,
    R.CUATM,
    R.CFP,
    R.CFOJ,
    R.CAEM2,
    MAX(CASE WHEN D.CAPITOL IN (100)  AND D.RIND NOT IN ('CD','-') THEN D.RIND ELSE NULL END) AS CAP_SR,
    ROUND(MAX(CASE WHEN D.CAPITOL IN (1129) AND D.RIND IN ('8') THEN D.COL31 ELSE NULL END), 2) AS CAEM_ACT,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('400') THEN D.COL3 ELSE NULL END), 2) AS RIND_400_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('400') THEN D.COL4 ELSE NULL END), 2) AS RIND_400_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('400') THEN D.COL5 ELSE NULL END), 2) AS RIND_400_COL3,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('410') THEN D.COL3 ELSE NULL END), 2) AS RIND_410_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('410') THEN D.COL4 ELSE NULL END), 2) AS RIND_410_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('410') THEN D.COL5 ELSE NULL END), 2) AS RIND_410_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('410') THEN D.COL31 ELSE NULL END), 2) AS RIND_410_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('411') THEN D.COL3 ELSE NULL END), 2) AS RIND_411_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('411') THEN D.COL4 ELSE NULL END), 2) AS RIND_411_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('411') THEN D.COL5 ELSE NULL END), 2) AS RIND_411_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('411') THEN D.COL31 ELSE NULL END), 2) AS RIND_411_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('412') THEN D.COL3 ELSE NULL END), 2) AS RIND_412_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('412') THEN D.COL4 ELSE NULL END), 2) AS RIND_412_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('412') THEN D.COL5 ELSE NULL END), 2) AS RIND_412_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('412') THEN D.COL31 ELSE NULL END), 2) AS RIND_412_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('413') THEN D.COL3 ELSE NULL END), 2) AS RIND_413_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('413') THEN D.COL4 ELSE NULL END), 2) AS RIND_413_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('413') THEN D.COL5 ELSE NULL END), 2) AS RIND_413_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('413') THEN D.COL31 ELSE NULL END), 2) AS RIND_413_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('414') THEN D.COL3 ELSE NULL END), 2) AS RIND_414_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('414') THEN D.COL4 ELSE NULL END), 2) AS RIND_414_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('414') THEN D.COL5 ELSE NULL END), 2) AS RIND_414_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('414') THEN D.COL31 ELSE NULL END), 2) AS RIND_414_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('415') THEN D.COL3 ELSE NULL END), 2) AS RIND_415_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('415') THEN D.COL4 ELSE NULL END), 2) AS RIND_415_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('415') THEN D.COL5 ELSE NULL END), 2) AS RIND_415_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('415') THEN D.COL31 ELSE NULL END), 2) AS RIND_415_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('416') THEN D.COL3 ELSE NULL END), 2) AS RIND_416_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('416') THEN D.COL4 ELSE NULL END), 2) AS RIND_416_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('416') THEN D.COL5 ELSE NULL END), 2) AS RIND_416_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('416') THEN D.COL31 ELSE NULL END), 2) AS RIND_416_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('417') THEN D.COL3 ELSE NULL END), 2) AS RIND_417_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('417') THEN D.COL4 ELSE NULL END), 2) AS RIND_417_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('417') THEN D.COL5 ELSE NULL END), 2) AS RIND_417_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('417') THEN D.COL31 ELSE NULL END), 2) AS RIND_417_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('418') THEN D.COL3 ELSE NULL END), 2) AS RIND_418_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('418') THEN D.COL4 ELSE NULL END), 2) AS RIND_418_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('418') THEN D.COL5 ELSE NULL END), 2) AS RIND_418_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('418') THEN D.COL31 ELSE NULL END), 2) AS RIND_418_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('419') THEN D.COL3 ELSE NULL END), 2) AS RIND_419_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('419') THEN D.COL4 ELSE NULL END), 2) AS RIND_419_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('419') THEN D.COL5 ELSE NULL END), 2) AS RIND_419_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('419') THEN D.COL31 ELSE NULL END), 2) AS RIND_419_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('420') THEN D.COL3 ELSE NULL END), 2) AS RIND_420_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('420') THEN D.COL4 ELSE NULL END), 2) AS RIND_420_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('420') THEN D.COL5 ELSE NULL END), 2) AS RIND_420_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('420') THEN D.COL31 ELSE NULL END), 2) AS RIND_420_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('421') THEN D.COL3 ELSE NULL END), 2) AS RIND_421_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('421') THEN D.COL4 ELSE NULL END), 2) AS RIND_421_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('421') THEN D.COL5 ELSE NULL END), 2) AS RIND_421_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('421') THEN D.COL31 ELSE NULL END), 2) AS RIND_421_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('422') THEN D.COL3 ELSE NULL END), 2) AS RIND_422_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('422') THEN D.COL4 ELSE NULL END), 2) AS RIND_422_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('422') THEN D.COL5 ELSE NULL END), 2) AS RIND_422_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('422') THEN D.COL31 ELSE NULL END), 2) AS RIND_422_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('423') THEN D.COL3 ELSE NULL END), 2) AS RIND_423_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('423') THEN D.COL4 ELSE NULL END), 2) AS RIND_423_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('423') THEN D.COL5 ELSE NULL END), 2) AS RIND_423_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('423') THEN D.COL31 ELSE NULL END), 2) AS RIND_423_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('424') THEN D.COL3 ELSE NULL END), 2) AS RIND_424_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('424') THEN D.COL4 ELSE NULL END), 2) AS RIND_424_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('424') THEN D.COL5 ELSE NULL END), 2) AS RIND_424_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('424') THEN D.COL31 ELSE NULL END), 2) AS RIND_424_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('425') THEN D.COL3 ELSE NULL END), 2) AS RIND_425_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('425') THEN D.COL4 ELSE NULL END), 2) AS RIND_425_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('425') THEN D.COL5 ELSE NULL END), 2) AS RIND_425_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('425') THEN D.COL31 ELSE NULL END), 2) AS RIND_425_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('426') THEN D.COL3 ELSE NULL END), 2) AS RIND_426_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('426') THEN D.COL4 ELSE NULL END), 2) AS RIND_426_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('426') THEN D.COL5 ELSE NULL END), 2) AS RIND_426_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('426') THEN D.COL31 ELSE NULL END), 2) AS RIND_426_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('427') THEN D.COL3 ELSE NULL END), 2) AS RIND_427_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('427') THEN D.COL4 ELSE NULL END), 2) AS RIND_427_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('427') THEN D.COL5 ELSE NULL END), 2) AS RIND_427_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('427') THEN D.COL31 ELSE NULL END), 2) AS RIND_427_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('428') THEN D.COL3 ELSE NULL END), 2) AS RIND_428_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('428') THEN D.COL4 ELSE NULL END), 2) AS RIND_428_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('428') THEN D.COL5 ELSE NULL END), 2) AS RIND_428_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('428') THEN D.COL31 ELSE NULL END), 2) AS RIND_428_CAEM,

    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('429') THEN D.COL3 ELSE NULL END), 2) AS RIND_429_COL1,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('429') THEN D.COL4 ELSE NULL END), 2) AS RIND_429_COL2,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('429') THEN D.COL5 ELSE NULL END), 2) AS RIND_429_COL3,
    ROUND(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('429') THEN D.COL31 ELSE NULL END), 2) AS RIND_429_CAEM

FROM   
    CIS2.VW_DATA_ALL D    
    INNER JOIN CIS2.RENIM R ON R.CUIIO = D.CUIIO AND R.CUIIO_VERS = D.CUIIO_VERS  
WHERE
    D.FORM IN (64)
    AND D.PERIOADA = :pPERIOADA
    AND D.CUATM_FULL LIKE '%' || :pCOD_CUATM || ';%'
    AND D.CAPITOL IN (1127, 1129, 100) 
    AND D.CUIIO IN (
        SELECT DISTINCT D.CUIIO 
        FROM (
            SELECT DISTINCT
                D.CUIIO,
                D.RIND,
                SUM(D.COL1) AS COL1
            FROM CIS2.VW_DATA_ALL D
            WHERE D.PERIOADA = :PERIOADA
              AND D.CAPITOL IN (100)
              AND D.FORM IN (64)
              AND D.RIND IN ('1','5','6')  
            GROUP BY D.CUIIO, D.RIND
            HAVING NVAL(SUM(D.COL1)) > 0
        ) D
    )
GROUP BY 
    D.ANUL,
    D.CUIIO,
    R.IDNO,
    R.DENUMIRE,
    R.CUATM,
    R.CFP,
    R.CFOJ,
    R.CAEM2;
